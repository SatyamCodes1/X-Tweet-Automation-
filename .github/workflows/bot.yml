name: x-funny-news-bot

on:
  schedule:
    # ‚úÖ Post 1 news every 2 hours (UTC) ‚Äî logic inside will block 10PM‚Äì4AM IST
    - cron: "0 */2 * * *"

    # ‚úÖ Google Trends at 12PM, 4PM, 8PM IST ‚Üí 06:30, 10:30, 14:30 UTC
    - cron: "30 6 * * *"
    - cron: "30 10 * * *"
    - cron: "30 14 * * *"

    # ‚úÖ Cache News at 6AM, 10AM, 2PM, 5PM, 8PM IST
    # Converted to UTC:
    # 06:00 IST ‚Üí 00:30 UTC
    # 10:00 IST ‚Üí 04:30 UTC
    # 14:00 IST ‚Üí 08:30 UTC
    # 17:00 IST ‚Üí 11:30 UTC
    # 20:00 IST ‚Üí 14:30 UTC
    - cron: "30 0 * * *"
    - cron: "30 4 * * *"
    - cron: "30 8 * * *"
    - cron: "30 11 * * *"
    - cron: "30 14 * * *"

  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: ‚úÖ Checkout repo
        uses: actions/checkout@v4

      - name: ‚úÖ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ‚úÖ Install dependencies
        run: pip install -r requirements.txt

      # ========== DETERMINE TRIGGER TYPE ==========
      - name: üîç Determine trigger type
        id: trigger
        run: |
          HOUR=$(date -u +%H)
          MINUTE=$(date -u +%M)
          
          echo "Current UTC time: $HOUR:$MINUTE"
          
          # Determine which task to run based on time
          TRIGGER="none"
          
          # Google Trends: 06:30, 10:30, 14:30 UTC
          if [[ ("$HOUR" == "06" && "$MINUTE" == "30") || \
                ("$HOUR" == "10" && "$MINUTE" == "30") || \
                ("$HOUR" == "14" && "$MINUTE" == "30") ]]; then
            TRIGGER="trend_window"
            echo "trigger=trend_window" >> $GITHUB_OUTPUT
            
          # Cache News: 00:30, 04:30, 08:30, 11:30, 14:30 UTC
          elif [[ ("$HOUR" == "00" && "$MINUTE" == "30") || \
                  ("$HOUR" == "04" && "$MINUTE" == "30") || \
                  ("$HOUR" == "08" && "$MINUTE" == "30") || \
                  ("$HOUR" == "11" && "$MINUTE" == "30") || \
                  ("$HOUR" == "14" && "$MINUTE" == "30") ]]; then
            TRIGGER="cache_news"
            echo "trigger=cache_news" >> $GITHUB_OUTPUT
            
          # Post News: Every 2 hours except 22:00-04:00 UTC (10PM-4AM IST)
          elif [[ $((HOUR % 2)) == 0 ]] && [[ ! ("$HOUR" -ge 22 || "$HOUR" -lt 4) ]]; then
            TRIGGER="news_batch"
            echo "trigger=news_batch" >> $GITHUB_OUTPUT
          fi
          
          echo "Selected trigger: $TRIGGER"

      # ========== POST GOOGLE TRENDS ==========
      - name: üöÄ Post Google Trends (India)
        if: steps.trigger.outputs.trigger == 'trend_window'
        run: |
          echo "üöÄ Starting Google Trends posting..."
          python -m src.run TRIGGER=trend_window
          echo "‚úÖ Google Trends posting completed"
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          USE_MEMES: "true"
          TEST_MODE: "false"
          HASHTAGS_ENABLED: "true"
          HASHTAGS_MAX: "2"
          DAILY_TWEET_LIMIT: "15"
          MONTHLY_TWEET_LIMIT: "450"
          LOG_FILE: "bot.log"

      # ========== CACHE NEWS ==========
      - name: üóûÔ∏è Cache Latest News
        if: steps.trigger.outputs.trigger == 'cache_news'
        run: |
          echo "üóûÔ∏è Starting news cache..."
          python -m src.run TRIGGER=cache_news
          echo "‚úÖ News cache completed"
        env:
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          DEFAULT_COUNTRY: "in"
          TEST_MODE: "false"
          LOG_FILE: "bot.log"

      # ========== POST NEWS TWEETS ==========
      - name: üê¶ Post News Tweets
        if: steps.trigger.outputs.trigger == 'news_batch'
        run: |
          echo "üê¶ Starting news tweet posting..."
          python -m src.run TRIGGER=news_batch
          echo "‚úÖ News tweet posting completed"
          
          # Check if log file exists and show last 20 lines
          if [ -f "bot.log" ]; then
            echo "üìã Bot log (last 20 lines):"
            tail -20 bot.log
          fi
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          USE_MEMES: "true"
          HASHTAGS_ENABLED: "true"
          HASHTAGS_MAX: "2"
          DAILY_TWEET_LIMIT: "15"
          MONTHLY_TWEET_LIMIT: "450"
          TEST_MODE: "false"
          LOG_FILE: "bot.log"

      # ========== ERROR LOGGING & DEBUGGING ==========
      - name: üìã Check for errors
        if: always()
        run: |
          echo "=== Workflow Status Check ==="
          echo "Trigger: ${{ steps.trigger.outputs.trigger }}"
          
          # Show bot.log if it exists
          if [ -f "bot.log" ]; then
            echo ""
            echo "=== Full Bot Log ==="
            cat bot.log
          else
            echo "‚ö†Ô∏è No bot.log file found"
          fi
          
          # Check if any tweets were actually posted
          if grep -q "Tweet posted successfully\|successfully posted\|tweet_id" bot.log 2>/dev/null; then
            echo "‚úÖ Tweets were posted successfully"
          else
            echo "‚ùå WARNING: No successful tweet posts detected in logs"
          fi

      # ========== UPLOAD LOGS AS ARTIFACT ==========
      - name: üì¶ Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-logs-${{ github.run_number }}
          path: bot.log
          retention-days: 7

      # ========== VALIDATE TWITTER CREDENTIALS ==========
      - name: üîê Validate Twitter API Credentials
        if: failure()
        run: |
          echo "‚ö†Ô∏è Workflow failed. Checking credentials..."
          
          if [ -z "$X_API_KEY" ]; then
            echo "‚ùå X_API_KEY is not set"
          else
            echo "‚úÖ X_API_KEY is set"
          fi
          
          if [ -z "$X_API_SECRET" ]; then
            echo "‚ùå X_API_SECRET is not set"
          else
            echo "‚úÖ X_API_SECRET is set"
          fi
          
          if [ -z "$X_ACCESS_TOKEN" ]; then
            echo "‚ùå X_ACCESS_TOKEN is not set"
          else
            echo "‚úÖ X_ACCESS_TOKEN is set"
          fi
          
          if [ -z "$X_ACCESS_SECRET" ]; then
            echo "‚ùå X_ACCESS_SECRET is not set"
          else
            echo "‚úÖ X_ACCESS_SECRET is set"
          fi
          
          if [ -z "$GROQ_API_KEY" ]; then
            echo "‚ùå GROQ_API_KEY is not set"
          else
            echo "‚úÖ GROQ_API_KEY is set"
          fi
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
