name: x-funny-news-bot

on:
  schedule:
    # ‚úÖ Post 1 news every 2 hours (UTC)
    - cron: "0 */2 * * *"

    # ‚úÖ Google Trends at 12PM, 4PM, 8PM IST ‚Üí 06:30, 10:30, 14:30 UTC
    - cron: "30 6 * * *"
    - cron: "30 10 * * *"
    - cron: "30 14 * * *"

    # ‚úÖ Cache News at 6AM, 10AM, 2PM, 5PM, 8PM IST
    - cron: "30 0 * * *"
    - cron: "30 4 * * *"
    - cron: "30 8 * * *"
    - cron: "30 11 * * *"
    - cron: "30 14 * * *"

  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: ‚úÖ Checkout repo
        uses: actions/checkout@v4

      - name: ‚úÖ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ‚úÖ Install dependencies
        run: pip install -r requirements.txt

      # ========== DETERMINE TRIGGER TYPE ==========
      - name: üîç Determine trigger type
        id: trigger
        run: |
          HOUR=$(date -u +%H)
          MINUTE=$(date -u +%M)
          
          echo "Current UTC time: $HOUR:$MINUTE"
          
          TRIGGER="none"
          
          # Google Trends: 06:30, 10:30, 14:30 UTC
          if [[ ("$HOUR" == "06" && "$MINUTE" == "30") || \
                ("$HOUR" == "10" && "$MINUTE" == "30") || \
                ("$HOUR" == "14" && "$MINUTE" == "30") ]]; then
            TRIGGER="trend_window"
            echo "trigger=trend_window" >> $GITHUB_OUTPUT
            
          # Cache News: 00:30, 04:30, 08:30, 11:30, 14:30 UTC
          elif [[ ("$HOUR" == "00" && "$MINUTE" == "30") || \
                  ("$HOUR" == "04" && "$MINUTE" == "30") || \
                  ("$HOUR" == "08" && "$MINUTE" == "30") || \
                  ("$HOUR" == "11" && "$MINUTE" == "30") ]] && [[ "$MINUTE" == "30" ]]; then
            TRIGGER="cache_news"
            echo "trigger=cache_news" >> $GITHUB_OUTPUT
            
          # Post News: Every 2 hours except 22:00-03:59 UTC (10PM-4AM IST)
          elif [[ $((HOUR % 2)) == 0 ]] && [[ $HOUR -lt 22 && $HOUR -ge 4 ]]; then
            TRIGGER="news_batch"
            echo "trigger=news_batch" >> $GITHUB_OUTPUT
          fi
          
          echo "Selected trigger: $TRIGGER"

      # ========== POST GOOGLE TRENDS ==========
      - name: üöÄ Post Google Trends (India)
        if: steps.trigger.outputs.trigger == 'trend_window'
        run: |
          echo "üöÄ Starting Google Trends posting..."
          python -m src.run TRIGGER=trend_window
          EXIT_CODE=$?
          echo "Exit code: $EXIT_CODE"
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          USE_MEMES: "true"
          TEST_MODE: "false"
          HASHTAGS_ENABLED: "true"
          HASHTAGS_MAX: "2"
          DAILY_TWEET_LIMIT: "15"
          MONTHLY_TWEET_LIMIT: "450"
          LOG_FILE: "bot.log"

      # ========== CACHE NEWS ==========
      - name: üóûÔ∏è Cache Latest News
        if: steps.trigger.outputs.trigger == 'cache_news'
        run: |
          echo "üóûÔ∏è Starting news cache..."
          python -m src.run TRIGGER=cache_news
          EXIT_CODE=$?
          echo "Exit code: $EXIT_CODE"
        env:
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          DEFAULT_COUNTRY: "in"
          TEST_MODE: "false"
          LOG_FILE: "bot.log"

      # ========== POST NEWS TWEETS ==========
      - name: üê¶ Post News Tweets
        if: steps.trigger.outputs.trigger == 'news_batch'
        run: |
          echo "üê¶ Starting news tweet posting..."
          python -m src.run TRIGGER=news_batch
          EXIT_CODE=$?
          echo "Exit code: $EXIT_CODE"
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          USE_MEMES: "true"
          HASHTAGS_ENABLED: "true"
          HASHTAGS_MAX: "2"
          DAILY_TWEET_LIMIT: "15"
          MONTHLY_TWEET_LIMIT: "450"
          TEST_MODE: "false"
          LOG_FILE: "bot.log"

      # ========== SHOW RESULTS ==========
      - name: üìã Show execution results
        if: always()
        run: |
          echo "=== Execution Results ==="
          echo "Trigger: ${{ steps.trigger.outputs.trigger }}"
          
          if [ -f "bot.log" ]; then
            echo ""
            echo "=== Bot Log Output ==="
            cat bot.log
          else
            echo "‚ö†Ô∏è No bot.log file found (code didn't run)"
          fi

      # ========== UPLOAD LOGS ==========
      - name: üì¶ Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-logs-${{ github.run_number }}
          path: bot.log
          retention-days: 7
