name: x-funny-news-bot

on:
  schedule:
    # News every 2 hours (UTC)
    - cron: "0 */2 * * *"
    # Trends at 12:00, 16:00, 20:00 IST ‚Üí 06:30, 10:30, 14:30 UTC
    - cron: "30 6 * * *"
    - cron: "30 10 * * *"
    - cron: "30 14 * * *"
    # Cache news twice/day (06:30 IST = 01:00 UTC, 18:30 IST = 13:00 UTC)
    - cron: "0 1 * * *"
    - cron: "0 13 * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: ‚úÖ Checkout repo
        uses: actions/checkout@v4

      - name: ‚úÖ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ‚úÖ Install dependencies
        run: pip install -r requirements.txt

      # --- Credential validation ---
      - name: üîê Verify Credentials
        run: |
          python - <<EOF
import os
import sys

print('=' * 60)
print('üîê CREDENTIAL VALIDATION')
print('=' * 60)

required_keys = {
    'X_API_KEY': os.getenv('X_API_KEY'),
    'X_API_SECRET': os.getenv('X_API_SECRET'),
    'X_ACCESS_TOKEN': os.getenv('X_ACCESS_TOKEN'),
    'X_ACCESS_SECRET': os.getenv('X_ACCESS_SECRET'),
    'GROQ_API_KEY': os.getenv('GROQ_API_KEY'),
    'GNEWS_API_KEY': os.getenv('GNEWS_API_KEY'),
    'NEWSAPI_KEY': os.getenv('NEWSAPI_KEY'),
}
all_valid = True
for key, value in required_keys.items():
    if not value:
        print(f'‚ùå MISSING: {key}')
        all_valid = False
    else:
        masked = value[:4] + '...' + value[-4:] if len(value) > 8 else '***'
        print(f'‚úÖ {key}: Present ({len(value)} chars) - {masked}')
print('=' * 60)
if all_valid:
    print('‚úÖ All credentials validated successfully')
else:
    print('‚ùå Some credentials are missing!')
    sys.exit(1)
EOF
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}

      - name: üîç Debug Environment
        run: |
          python - <<EOF
import os
print('=' * 60)
print('üîç ENVIRONMENT VARIABLES')
print('=' * 60)
env_vars = {
    'TRIGGER': os.getenv('TRIGGER', 'NOT SET'),
    'DEFAULT_COUNTRY': os.getenv('DEFAULT_COUNTRY', 'NOT SET'),
    'USE_MEMES': os.getenv('USE_MEMES', 'NOT SET'),
    'HASHTAGS_ENABLED': os.getenv('HASHTAGS_ENABLED', 'NOT SET'),
    'HASHTAGS_MAX': os.getenv('HASHTAGS_MAX', 'NOT SET'),
    'TRENDS_PER_WINDOW': os.getenv('TRENDS_PER_WINDOW', 'NOT SET'),
    'DAILY_TWEET_LIMIT': os.getenv('DAILY_TWEET_LIMIT', 'NOT SET'),
    'MONTHLY_TWEET_LIMIT': os.getenv('MONTHLY_TWEET_LIMIT', 'NOT SET'),
    'TEST_MODE': os.getenv('TEST_MODE', 'NOT SET'),
    'LOG_FILE': os.getenv('LOG_FILE', 'NOT SET'),
}
for key, value in env_vars.items():
    print(f'{key}: {value}')
print('=' * 60)
print(f'Current Working Directory: {os.getcwd()}')
import sys
print(f'Python Version: {sys.version}')
EOF
        env:
          TRIGGER: ${{ env.TRIGGER }}
          DEFAULT_COUNTRY: ${{ env.DEFAULT_COUNTRY }}
          USE_MEMES: ${{ env.USE_MEMES }}
          HASHTAGS_ENABLED: ${{ env.HASHTAGS_ENABLED }}
          HASHTAGS_MAX: ${{ env.HASHTAGS_MAX }}
          TRENDS_PER_WINDOW: ${{ env.TRENDS_PER_WINDOW }}
          DAILY_TWEET_LIMIT: ${{ env.DAILY_TWEET_LIMIT }}
          MONTHLY_TWEET_LIMIT: ${{ env.MONTHLY_TWEET_LIMIT }}
          TEST_MODE: ${{ env.TEST_MODE }}
          LOG_FILE: ${{ env.LOG_FILE }}

      - name: üöÄ Google Trends (India)
        if: ${{ contains(github.event.schedule, '30 6') || contains(github.event.schedule, '30 10') || contains(github.event.schedule, '30 14') || github.event_name == 'workflow_dispatch' }}
        run: |
          echo "üöÄ Starting Google Trends trigger..."
          python -m src.run 2>&1 | tee -a bot.log
          EXIT_CODE=$?
          echo "Exit Code: $EXIT_CODE"
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Process failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi
          echo "‚úÖ Process completed successfully"
        env:
          TRIGGER: trend_window
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          DEFAULT_COUNTRY: "in"
          USE_MEMES: "true"
          HASHTAGS_ENABLED: "true"
          HASHTAGS_MAX: "2"
          TRENDS_PER_WINDOW: "1"
          DAILY_TWEET_LIMIT: "15"
          MONTHLY_TWEET_LIMIT: "450"
          TEST_MODE: "false"
          LOG_FILE: "bot.log"

      - name: üóû Cache latest news
        if: ${{ contains(github.event.schedule, '0 1') || contains(github.event.schedule, '0 13') || github.event_name == 'workflow_dispatch' }}
        run: |
          echo "üóû Starting cache news trigger..."
          python -m src.run 2>&1 | tee -a bot.log
          EXIT_CODE=$?
          echo "Exit Code: $EXIT_CODE"
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Process failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi
          echo "‚úÖ Process completed successfully"
        env:
          TRIGGER: cache_news
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          DEFAULT_COUNTRY: "in"
          TEST_MODE: "false"
          LOG_FILE: "bot.log"

      - name: üê¶ Post one News Tweet (every 2h)
        if: ${{ contains(github.event.schedule, '0 */2') || github.event_name == 'workflow_dispatch' }}
        run: |
          echo "üê¶ Starting news batch trigger..."
          python -m src.run 2>&1 | tee -a bot.log
          EXIT_CODE=$?
          echo "Exit Code: $EXIT_CODE"
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Process failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi
          echo "‚úÖ Process completed successfully"
        env:
          TRIGGER: news_batch
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          USE_MEMES: "true"
          HASHTAGS_ENABLED: "true"
          HASHTAGS_MAX: "2"
          DAILY_TWEET_LIMIT: "15"
          MONTHLY_TWEET_LIMIT: "450"
          TEST_MODE: "false"
          LOG_FILE: "bot.log"

      - name: üìã Display bot logs
        if: always()
        run: |
          printf '=%.0s' {1..60}
          echo
          echo "üìã BOT LOGS CONTENTS"
          printf '=%.0s' {1..60}
          echo
          if [ -f bot.log ]; then
            cat bot.log
          else
            echo "‚ùå bot.log file not found"
          fi
          printf '=%.0s' {1..60}
          echo

      - name: üì¶ Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-logs-${{ github.run_id }}
          path: bot.log
          retention-days: 30

      - name: üêç Capture Python errors
        if: always()
        run: |
          echo "Checking for error files..."
          if [ -d "errors" ]; then
            echo "Error directory found:"
            ls -la errors/
          else
            echo "No error directory found"
          fi
          if [ -f "debug.log" ]; then
            echo "Debug log found:"
            cat debug.log
          fi

      - name: ‚ú® Workflow Summary
        if: always()
        run: |
          printf '=%.0s' {1..60}
          echo
          echo "‚ú® WORKFLOW EXECUTION SUMMARY"
          printf '=%.0s' {1..60}
          echo
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "Event: ${{ github.event_name }}"
          echo "Trigger: ${{ env.TRIGGER }}"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          printf '=%.0s' {1..60}
          echo
